<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Gerenciador Financeiro Pro - Controle suas finanÃ§as de forma simples e eficiente com integraÃ§Ã£o Google Sheets">
    <meta name="theme-color" content="#3B82F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Gerenciador Financeiro Pro v4.1.2</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’°</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’°</text></svg>">
    
    <!-- Estilos -->
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Chart.js para grÃ¡ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- SheetJS para manipulaÃ§Ã£o de Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>ğŸ’° Financeiro Pro</h1>
                <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle menu">â˜°</button>
            </div>
            
            <!-- BotÃ£o de Importar da Planilha -->
            <div class="sidebar-sync-button">
                <button class="btn btn-sync" id="btnImportFromSheets" onclick="importarDaPlanilha()" title="Importar dados da planilha Google Sheets">
                    <span class="sync-icon">ğŸ”„</span>
                    <span class="sync-text">Importar da Planilha</span>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <h3>Principal</h3>
                    <button class="nav-button active" data-view="dashboard">
                        <span class="nav-icon">ğŸ“Š</span>
                        <span class="nav-text">Dashboard</span>
                    </button>
                    <button class="nav-button" data-view="transactions">
                        <span class="nav-icon">ğŸ’³</span>
                        <span class="nav-text">TransaÃ§Ãµes</span>
                    </button>
                    <button class="nav-button" data-view="accounts">
                        <span class="nav-icon">ğŸ¦</span>
                        <span class="nav-text">Contas</span>
                    </button>
                    <button class="nav-button" data-view="categories">
                        <span class="nav-icon">ğŸ·ï¸</span>
                        <span class="nav-text">Categorias</span>
                    </button>
                </div>

                <div class="nav-section">
                    <h3>Vendas</h3>
                    <button class="nav-button" data-view="sales">
                        <span class="nav-icon">ğŸ›’</span>
                        <span class="nav-text">Vendas</span>
                    </button>
                    <button class="nav-button" data-view="customers">
                        <span class="nav-icon">ğŸ‘¥</span>
                        <span class="nav-text">Clientes</span>
                    </button>
                    <button class="nav-button" data-view="products">
                        <span class="nav-icon">ğŸ“¦</span>
                        <span class="nav-text">Produtos</span>
                    </button>
                </div>

                <div class="nav-section">
                    <h3>RecebÃ­veis</h3>
                    <button class="nav-button" data-view="debtors">
                        <span class="nav-icon">ğŸ‘¤</span>
                        <span class="nav-text">Devedores</span>
                    </button>
                </div>

                <div class="nav-section">
                    <h3>Planejamento</h3>
                    <button class="nav-button" data-view="budgets">
                        <span class="nav-icon">ğŸ“‹</span>
                        <span class="nav-text">OrÃ§amentos</span>
                    </button>
                    <button class="nav-button" data-view="goals">
                        <span class="nav-icon">ğŸ¯</span>
                        <span class="nav-text">Metas</span>
                    </button>
                    <button class="nav-button" data-view="investments">
                        <span class="nav-icon">ğŸ“ˆ</span>
                        <span class="nav-text">Investimentos</span>
                    </button>
                    <button class="nav-button" data-view="debts">
                        <span class="nav-icon">ğŸ’³</span>
                        <span class="nav-text">DÃ­vidas</span>
                    </button>
                </div>

                <div class="nav-section">
                    <h3>AnÃ¡lises</h3>
                    <button class="nav-button" data-view="reports">
                        <span class="nav-icon">ğŸ“‘</span>
                        <span class="nav-text">RelatÃ³rios</span>
                    </button>
                </div>

                <div class="nav-section">
                    <h3>Sistema</h3>
                    <button class="nav-button" data-view="activity-logs">
                        <span class="nav-icon">ğŸ“‹</span>
                        <span class="nav-text">Logs de Atividade</span>
                    </button>
                    <button class="nav-button" data-view="import-export">
                        <span class="nav-icon">ğŸ“¤</span>
                        <span class="nav-text">Importar/Exportar</span>
                    </button>
                    <button class="nav-button" data-view="google-sheets">
                        <span class="nav-icon">ğŸ“Š</span>
                        <span class="nav-text">Google Sheets</span>
                        <span class="sync-indicator" id="syncIndicator" title="Status de sincronizaÃ§Ã£o"></span>
                    </button>
                    <button class="nav-button" data-view="settings">
                        <span class="nav-icon">âš™ï¸</span>
                        <span class="nav-text">ConfiguraÃ§Ãµes</span>
                    </button>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="profile-selector">
                    <select id="profileSelector" onchange="uiManager.switchProfile(this.value)">
                        <!-- Preenchido via JavaScript -->
                    </select>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- HEADER -->
            <header class="header">
                <div class="header-left">
                    <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Menu">â˜°</button>
                    <h2 id="pageTitle">ğŸ“Š Dashboard</h2>
                </div>
                <div class="header-actions">
                    <!-- Sync Status -->
                    <div class="sync-status" id="syncStatus" title="Status de sincronizaÃ§Ã£o">
                        <span class="sync-icon" id="syncIcon">â˜ï¸</span>
                        <span class="sync-text" id="syncText">Offline</span>
                    </div>
                    <!-- User Info -->
                    <div class="user-info" id="userInfo">
                        <span class="user-avatar" id="userAvatar">ğŸ‘¤</span>
                        <span class="user-name" id="userName">UsuÃ¡rio</span>
                    </div>
                    <button class="btn-header" onclick="uiManager.exportJSON()" title="Fazer Backup (Ctrl+S)">
                        <span>ğŸ’¾</span>
                        <span class="btn-text">Backup</span>
                    </button>
                    <button class="btn-header" onclick="syncWithGoogleSheets()" title="Sincronizar com Google Sheets" id="btnSync">
                        <span>ğŸ”„</span>
                        <span class="btn-text">Sync</span>
                    </button>
                    <button class="btn-header btn-theme" onclick="uiManager.toggleDarkMode()" title="Alternar Tema">
                        <span id="themeIcon">ğŸŒ™</span>
                    </button>
                    <button class="btn-header btn-logout" onclick="handleLogout()" title="Sair">
                        <span>ğŸšª</span>
                        <span class="btn-text">Sair</span>
                    </button>
                </div>
            </header>

            <!-- CONTENT AREA -->
            <div class="content">
                <!-- DASHBOARD VIEW -->
                <section id="dashboardView" class="view-section active">
                    <div class="loading">Carregando...</div>
                </section>

                <!-- TRANSACTIONS VIEW -->
                <section id="transactionsView" class="view-section"></section>

                <!-- ACCOUNTS VIEW -->
                <section id="accountsView" class="view-section"></section>

                <!-- CATEGORIES VIEW -->
                <section id="categoriesView" class="view-section"></section>

                <!-- SALES VIEW -->
                <section id="salesView" class="view-section"></section>

                <!-- CUSTOMERS VIEW -->
                <section id="customersView" class="view-section"></section>

                <!-- PRODUCTS VIEW -->
                <section id="productsView" class="view-section"></section>

                <!-- DEBTORS VIEW -->
                <section id="debtorsView" class="view-section"></section>

                <!-- BUDGETS VIEW -->
                <section id="budgetsView" class="view-section"></section>

                <!-- GOALS VIEW -->
                <section id="goalsView" class="view-section"></section>

                <!-- INVESTMENTS VIEW -->
                <section id="investmentsView" class="view-section"></section>

                <!-- DEBTS VIEW -->
                <section id="debtsView" class="view-section"></section>

                <!-- REPORTS VIEW -->
                <section id="reportsView" class="view-section"></section>

                <!-- ACTIVITY LOGS VIEW -->
                <section id="activityLogsView" class="view-section"></section>

                <!-- IMPORT/EXPORT VIEW -->
                <section id="importExportView" class="view-section"></section>

                <!-- GOOGLE SHEETS VIEW -->
                <section id="googleSheetsView" class="view-section"></section>

                <!-- SETTINGS VIEW -->
                <section id="settingsView" class="view-section"></section>
            </div>
        </main>
    </div>

    <!-- OVERLAY para mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- SCRIPTS -->
    <script src="js/config.js"></script>
    <script src="js/utils.js?v=4.3"></script>
    <script src="js/modal.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/google-sheets.js?v=10"></script>
    <script src="js/finance-manager.js"></script>
    <script src="js/sales-manager.js"></script>
    <script src="js/debtors-manager.js"></script>
    <script src="js/ui-manager.js?v=4.3"></script>
    <script src="js/ui-views.js"></script>
    <script src="js/sales-views.js"></script>
    <script src="js/debtors-views.js"></script>
    <script src="js/logs-view.js"></script>
    <script src="js/google-sheets-view.js?v=10"></script>
    
    <script>
        // Verificar autenticaÃ§Ã£o ao carregar
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar se estÃ¡ logado
            if (!authManager.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            // Garantir que uiManager seja inicializado
            if (!window.uiManager && typeof UIManager === 'function') {
                window.uiManager = new UIManager();
                window.uiManager.init();
            }

            // Atualizar informaÃ§Ãµes do usuÃ¡rio no header
            updateUserInfo();
            
            // Atualizar seletor de perfil
            updateProfileSelector();
            
            // Setup mobile menu
            setupMobileMenu();
            
            // Atualizar Ã­cone do tema
            updateThemeIcon();
            
            // Inicializar status de sincronizaÃ§Ã£o
            updateSyncStatusUI();
            
            // Escutar mudanÃ§as no status de sincronizaÃ§Ã£o
            window.addEventListener('syncStatusChanged', updateSyncStatusUI);
            window.addEventListener('googleSheetsConnected', updateSyncStatusUI);
            
            // Inicializar Google Sheets automaticamente
            initGoogleSheetsAuto();
        });

        function updateUserInfo() {
            let user = null;
            
            // Tentar obter do authManager primeiro
            if (typeof authManager !== 'undefined' && authManager.getCurrentUser) {
                user = authManager.getCurrentUser();
            }
            
            // Fallback: ler diretamente do localStorage
            if (!user) {
                try {
                    // Tentar ler sessÃ£o direta (login via Google)
                    const sessionData = localStorage.getItem(CONFIG.STORAGE_KEYS.SESSION);
                    if (sessionData) {
                        user = JSON.parse(sessionData);
                    }
                } catch (e) {
                    console.error('Erro ao ler sessÃ£o:', e);
                }
            }
            
            if (user) {
                const avatarEl = document.getElementById('userAvatar');
                const nameEl = document.getElementById('userName');
                const userInfo = document.getElementById('userInfo');
                
                // Se tem foto do Google, usar imagem
                if (user.googlePicture && avatarEl) {
                    avatarEl.innerHTML = `<img src="${user.googlePicture}" alt="${user.displayName}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`;
                } else if (avatarEl) {
                    avatarEl.textContent = user.avatar || 'ğŸ‘¤';
                }
                
                if (nameEl) {
                    nameEl.textContent = user.displayName || user.username || 'UsuÃ¡rio';
                }
                
                if (userInfo && user.color) {
                    userInfo.style.borderColor = user.color;
                }
                
                // Mostrar email se login via Google
                if (user.loginMethod === 'google' && user.email) {
                    nameEl.title = user.email;
                }
            }
        }

        async function handleLogout() {
            const confirmed = await Modal.confirmAction(
                'Sair do Sistema',
                'Deseja realmente sair do sistema?',
                { confirmText: 'Sair', dangerous: false }
            );
            
            if (confirmed) {
                authManager.logout();
                window.location.href = 'login.html';
            }
        }

        function updateProfileSelector() {
            const selector = document.getElementById('profileSelector');
            if (selector && financeManager) {
                selector.innerHTML = financeManager.businesses.map(b => 
                    `<option value="${b.id}" ${b.id === financeManager.currentBusinessId ? 'selected' : ''}>
                        ${b.name}
                    </option>`
                ).join('');
            }
        }

        function setupMobileMenu() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const sidebarToggle = document.getElementById('sidebarToggle');

            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('open');
                    overlay.classList.toggle('active');
                });
            }

            if (overlay) {
                overlay.addEventListener('click', () => {
                    sidebar.classList.remove('open');
                    overlay.classList.remove('active');
                });
            }

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                });
            }
        }

        function updateThemeIcon() {
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                const isDark = document.body.classList.contains('dark-mode') || 
                              localStorage.getItem('gfp_dark_mode') === 'true';
                themeIcon.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
            }
        }

        function updateSyncStatusUI() {
            const status = googleSheetsManager.getSyncStatus();
            const syncIcon = document.getElementById('syncIcon');
            const syncText = document.getElementById('syncText');
            const syncIndicator = document.getElementById('syncIndicator');
            
            const statusConfig = {
                'connected': { icon: 'â˜ï¸', text: 'Conectado', class: 'connected' },
                'syncing': { icon: 'ğŸ”„', text: 'Sincronizando...', class: 'syncing' },
                'synced': { icon: 'âœ“', text: 'Sincronizado', class: 'synced' },
                'error': { icon: 'âš ï¸', text: 'Erro', class: 'error' },
                'disconnected': { icon: 'â˜ï¸', text: 'Offline', class: 'disconnected' }
            };
            
            const config = statusConfig[status.status] || statusConfig.disconnected;
            
            if (syncIcon) syncIcon.textContent = config.icon;
            if (syncText) syncText.textContent = config.text;
            if (syncIndicator) {
                syncIndicator.className = 'sync-indicator ' + config.class;
            }
            
            // Atualizar classe do status
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                syncStatus.className = 'sync-status ' + config.class;
            }
        }

        async function initGoogleSheetsAuto() {
            // Aguardar um pouco para garantir que tudo foi carregado
            setTimeout(async () => {
                if (window.googleSheetsManager) {
                    console.log('ğŸš€ Iniciando conexÃ£o automÃ¡tica com Google Sheets...');
                    
                    // Verificar se jÃ¡ estÃ¡ autenticado
                    if (googleSheetsManager.checkAuth()) {
                        console.log('âœ… JÃ¡ conectado ao Google Sheets');
                        updateSyncStatusUI();
                        return;
                    }
                    
                    // Tentar inicializar e conectar automaticamente
                    try {
                        await googleSheetsManager.initialize();
                        console.log('âœ… Google Sheets API pronta');
                    } catch (e) {
                        console.log('âš ï¸ Erro na inicializaÃ§Ã£o automÃ¡tica:', e);
                    }
                }
            }, 1000);
        }

        async function syncWithGoogleSheets() {
            // Credenciais jÃ¡ estÃ£o configuradas no cÃ³digo
            if (!googleSheetsManager.checkAuth()) {
                Toast.show('Conectando ao Google Sheets...', 'info');
                const authorized = await googleSheetsManager.authorize();
                if (!authorized) {
                    Toast.show('Falha na autorizaÃ§Ã£o. Tente novamente.', 'error');
                    return;
                }
            }
            
            await googleSheetsManager.syncAll();
        }

        // Escutar evento de dados importados para atualizar a UI
        window.addEventListener('dataImported', () => {
            console.log('ğŸ”„ Dados importados, atualizando interface...');
            if (uiManager && uiManager.refreshCurrentView) {
                uiManager.refreshCurrentView();
            }
            updateSyncStatusUI();
        });

        // FunÃ§Ã£o para importar dados da planilha (botÃ£o no sidebar)
        async function importarDaPlanilha() {
            const btn = document.getElementById('btnImportFromSheets');
            const originalText = btn ? btn.innerHTML : '';
            
            try {
                // Mostrar loading
                if (btn) {
                    btn.innerHTML = '<span class="sync-icon spinning">ğŸ”„</span><span class="sync-text">Importando...</span>';
                    btn.disabled = true;
                }
                
                Toast.show('Importando dados da planilha...', 'info');
                
                // Conectar se nÃ£o estiver conectado
                if (!googleSheetsManager.isConnected) {
                    await googleSheetsManager.connect();
                }
                
                // Importar dados
                const success = await googleSheetsManager.importAllData();
                
                if (success) {
                    // Recarregar dados dos managers
                    if (typeof financeManager !== 'undefined') {
                        financeManager.loadAllData();
                    }
                    if (typeof salesManager !== 'undefined') {
                        salesManager.loadAllData();
                    }
                    if (typeof debtorsManager !== 'undefined') {
                        debtorsManager.loadAllData();
                    }
                    
                    // Atualizar interface
                    if (uiManager && uiManager.refreshCurrentView) {
                        uiManager.refreshCurrentView();
                    }
                    
                    Toast.show('Dados importados com sucesso!', 'success');
                } else {
                    Toast.show('Nenhum dado encontrado na planilha', 'warning');
                }
            } catch (error) {
                console.error('Erro ao importar:', error);
                Toast.show('Erro ao importar: ' + error.message, 'error');
            } finally {
                // Restaurar botÃ£o
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }

        // Atalhos de teclado
        document.addEventListener('keydown', (e) => {
            // Ctrl+S para backup
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                uiManager.exportJSON();
            }
            
            // Ctrl+Shift+S para sincronizar
            if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                e.preventDefault();
                syncWithGoogleSheets();
            }
            
            // Ctrl+Shift+I para importar
            if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                e.preventDefault();
                importarDaPlanilha();
            }
        });
    </script>
</body>
</html>
